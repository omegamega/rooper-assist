<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<script type="text/javascript" src="lib/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="js/tragedyset.js"></script>
	<script type="text/javascript">
	var npcs = {
		boy		: {
			name	: "男子学生",
			anxiety	: 2,
		},
		girl		: {
			name	: "女子学生",
			anxiety	: 3,
		},
		daughter		: {
			name	: "お嬢様",
			anxiety	: 1,
		},
		miko		: {
			name	: "巫女",
			anxiety	: 2,
		},
		detective	: {
			name	: "刑事",
			anxiety	: 3,
		},
		salaryman	: {
			name	: "サラリーマン",
			anxiety	: 2,
		},
		informer	: {
			name	: "情報屋",
			anxiety	: 3,
		},
		doctor		: {
			name	: "医者",
			anxiety	: 2,
		},
		patient		: {
			name	: "入院患者",
			anxiety	: 2,
		},
	}
	
	var accidents = {
		none		: {
			name	: "-",
			effect	: [],
		},
		murder		: {
			name	: "殺人事件",
			effect	: [
					{
						timing	: '',
						text	: "犯人と同じエリアにいる犯人以外のキャラクター1人を死亡させる",
					},
				],
		},
		pollution	: {
			name	: "邪気の汚染",
			effect	: [
					{
						timing	: '',
						text	: "神社に[暗躍C]を2つ置く",
					},
				],
		},
		hospital	: {
			name	: "病院の事件",
			effect	: [
					{
						timing	: '',
						text	: "病院に[暗躍C]が1つ以上→病院にいるすべてのキャラクターを死亡させる",
					},
					{
						timing	: '',
						text	: "病院に[暗躍C]が2つ以上→<span class=\"type_terminator\">主人公を死亡</span>させる",
					},
				],
		},
		sucide		: {
			name	: "自殺",
			effect	: [
					{
						timing	: '',
						text	: "犯人は死亡する",
					},
				],
		},
		anxietygrow	: {
			name	: "不安拡大",
			effect	: [
					{
						timing	: '',
						text	: "任意のキャラクター1人に[不安C]を2つ置き、別のキャラクター1人に[暗躍C]を1つ置く",
					},
				],
		},
		parting		: {
			name	: "別離",
			effect	: [
					{
						timing	: '',
						text	: "犯人を任意のボードに移動させる",
					},
				],
		},
		reveal		: {
			name	: "暴露",
			effect	: [
					{
						timing	: '',
						text	: "【選択】犯人と同じエリアにいるキャラクターから[友好C]を2つまで取り除く(割り振り可)",
					},
					{
						timing	: '',
						text	: "【選択】犯人と同じエリアにいるキャラクターに[友好C]を2つまで置く(割り振り可)",
					},
				],
		},
	}
	
	
	replaceAll = function(expression, org, dest) {  
		return expression.split(org).join(dest);  
	}  
	
	decorateSkill = function(skills) {
		var t = '';
		if(skills.length > 0){
			for(var i=0;i<skills.length;i++) {
				var s = skills[i];
				var tx = s.text;
				tx = replaceAll(tx,"【","<span class=\"skill_" + s.timing +"\">【");
				tx = replaceAll(tx,"】","】</span>");
				tx = replaceAll(tx,"[暗躍C]","<span class=\"bad_counter\">[暗躍C]</span>");
				tx = replaceAll(tx,"[不安C]","<span class=\"anxiety_counter\">[不安C]</span>");

				t += "<p>" + tx + "</p>";
			}
		}else{
			t = '<span class="gray">-</span>';
		}
		return t;
	}
	
	// 役職の人数チェックをする
	updateRoleCount = function(){
		// ルールX,Yから役職人数を算出
		var role_number = {};
		for(var i in roles) {
			role_number[i] = 0;
		}
		
		function getRoleNum(rules,rule,role) {
			return (rules[rule].roles[role] != undefined) ? rules[rule].roles[role] : 0;
		}
		for(var i in roles) {
			role_number[i] +=
				getRoleNum(rule_y, $('.rule_y_selector').val() ,i)
				+ getRoleNum(rule_x, $('.rule_x1_selector').val() ,i)
				+ getRoleNum(rule_x, $('.rule_x2_selector').val() ,i);
		}
		
		// TODO:上限付き役職チェック
		
		// 役職テーブルの状態を見て、過不足を算出する
		for(var i in npcs) {
			role_number[$('select.role_selector.role_' + i).val()]--;
		}
		var role_str = '';
		
		if($('.rule_x1_selector').val() == $('.rule_x2_selector').val()) {
			role_str = "<span class=\"red\">ルールX1とX2が重複</span>";
		}
		for(var i in roles) {
			if(i == 'person') continue;
			
			if(role_number[i] > 0) {
				if(role_str != '') {
					role_str += "/";
				}
				role_str += "<span class=\"red\">" + roles[i].name + "</span>" + role_number[i] + "人不足";
			}
			if(role_number[i] < 0) {
				if(role_str != '') {
					role_str += "/";
				}
				role_str += "<span class=\"blue\">" + roles[i].name + "</span>" + (-role_number[i]) + "人過剰";
			}
		}
		if(role_str == '') role_str = '準備完了';
		
		$('#role_notice > tbody > tr').remove();
		$('#role_notice > tbody').append('<tr><td>' + role_str + '</td></tr>');
	}
	
	// 役職テーブルのスキル欄を更新する
	updateRoleSkill = function() {
		for(var i in npcs) {
			$('.role_skill.role_' + i).html(decorateSkill(roles[$('.role_selector.role_' + i).val()].skill));
		};
	}
	
	// 役職テーブルの準備
	createRoleTable = function() {
		$('#role_table > tbody > tr').remove();
		for(var i in npcs) {
			var line = '<tr>'
				+ '<td>' + npcs[i].name + '</td>'
				+ '<td><select class="role_selector role_' + i + '"></select></td>'
				+ '<td><span class="role_skill role_' + i + '"></span></td>'
				+ '</tr>';
			$('#role_table > tbody').append(line);
		}
		for(var i in roles) {
			$('.role_selector').append('<option value=' + i + ' class="role_' + i +'">' + roles[i].name + '</option>');
		}
		
		$('.role_selector').change(updateRoleSkill).change();
		$('.role_selector').change(updateRoleCount).change();
	}
	
	// 事件効果を更新する
	updateAccidentEffect = function() {
		for(var i=1;i <= $('.day_selector').val();i++) {
			$('.accident_effect.day_' + i).html(decorateSkill(accidents[$('.accident_selector.day_' + i).val()].effect));
			if($('.accident_selector.day_' + i).val() == 'none') {
				$('.accident_criminal_selector.day_' + i).hide();
			}else{
				$('.accident_criminal_selector.day_' + i).show();
			}
		};
	}
	
	// 事件テーブルの準備
	updateAccidentTable = function() {
		$('#accident_table > tbody > tr').remove();
		for(var i=1;i <= $('.day_selector').val();i++) {
			var line = '<tr>'
				+ '<td>' + i + '</td>'
				+ '<td><select class="accident_selector day_' + i + '"></select></td>'
				+ '<td><select class="accident_criminal_selector day_' + i +'"></select></td>'
				+ '<td><span class="accident_effect day_' + i + '"></span></td>'
				+ '</tr>';
			$('#accident_table > tbody').append(line);
		}
		
		for(var i in npcs) {
			$('.accident_criminal_selector').append('<option value=' + i + '>' + npcs[i].name + '《' + npcs[i].anxiety + '》</option>');
		}
		
		for(var i in accidents) {
			$('.accident_selector').append('<option value=' + i + '>' + accidents[i].name + '</option>');
		}
		$('.accident_selector').change(updateAccidentEffect).change();
	}
	
	updateRuleAdditional = function(){
		$('.rule_y_additional').html(decorateSkill(rule_y[$('.rule_y_selector').val()].additional));
		$('.rule_x1_additional').html(decorateSkill(rule_x[$('.rule_x1_selector').val()].additional));
		$('.rule_x2_additional').html(decorateSkill(rule_x[$('.rule_x2_selector').val()].additional));
	}
	
	var init = function(){
		// ループ回数
		for(var i=1;i<9;i++) {
			$('.loop_selector,.day_selector').append('<option value=' + i + '>' + i + '</option>');
		}
		$('.loop_selector').val(4);
		$('.day_selector').val(7);
		
		// ルールY
		for(var i=0;i<rule_y.length;i++) {
			var r = rule_y[i];
			$('.rule_y_selector').append('<option value=' + i + '>' + r.name + '</option>');
		}
		
		// ルールX
		for(var i=0;i<rule_x.length;i++) {
			var r = rule_x[i];
			$('.rule_x1_selector,.rule_x2_selector').append('<option value=' + i + '>' + r.name + '</option>');
		}
		
		createRoleTable();
		$('.day_selector').change(updateAccidentTable).change();
		$('.rule_y_selector,.rule_x1_selector,.rule_x2_selector').change(updateRuleAdditional).change();
		$('.rule_y_selector,.rule_x1_selector,.rule_x2_selector').change(updateRoleCount).change();
	}
	</script>
	</head>
	<style>	
		th						{background-color:#111;	color:#eee;}
		th.label				{width:120px;}
		th.name					{width:160px;}
		th.additional 			{width:320px;}
		th.number				{width:64px;}
		span.red				{color:#f11; font-weight:bold;}
		span.blue				{color:#11f; font-weight:bold;}
		span.gray				{color:#ddd;}
		span.skill_passive		{color:#111; font-weight:bold;}
		span.skill_writer		{color:#1d1; font-weight:bold;}
		span.skill_turnend		{color:#11e; font-weight:bold;}
		span.skill_loopend,span.skill_loopstart		{color:#881; font-weight:bold;}
		span.type_terminator	{color:#f11; font-weight:bold;}
		span.anxiety_counter	{color:#414; background-color:#d8d;}
		span.bad_counter		{color:#441; background-color:#dd8;}
		span.fav_counter		{color:#144; background-color:#d4a;}
		.role_skill p, .accident_effect p, .rule_additional p				{padding:0px; spacing:0px; margin:0px;}
		
	</style>
<body>

<table id="loop">
	<thead>
		<tr>
			<th class="label">ループ回数</th>
			<th class="label">日数</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>
				<select class="loop_selector"></select>
			</td>
			<td>
				<select class="day_selector"></select>
			</td>
		</tr>
	</tbody>
</table>

<table id="rule_table">
	<thead>
		<tr>
			<th class="label">ルール</th>
			<th class="name">ルール</th>
			<th class="additional">追加ルール</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<th>ルールY</th>
			<td>
				<select class="rule_y_selector"></select>
			</td>
			<td>
				<span class="rule_y_additional rule_additional"></span>
			</td>
		</tr>
		<tr>
			<th>ルールX1</th>
			<td>
				<select class="rule_x1_selector rule_additional"></select>
			</td>
			<td>
				<span class="rule_x1_additional rule_additional"></span>
			</td>
		</tr>
		<tr>
			<th>ルールX2</th>
			<td>
				<select class="rule_x2_selector"></select>
			</td>
			<td>
				<span class="rule_x2_additional"></span>
			</td>
		</tr>
	</tbody>
</table>


<p></p>
<p></p>

<table id="role_notice">
	<thead>
		<tr>
			<th class="label">役職</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<p></p>

<table id="role_table">
	<thead>
		<tr>
			<th class="label">人物</th>
			<th class="name">役職</th>
			<th class="additional">追加ルール</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<table id="accident_table">
	<thead>
		<tr>
			<th class="number">日数</th>
			<th class="label">事件</th>
			<th class="name">犯人</th>
			<th class="additional">事件効果</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>


<script language="javascript">
	$(window).load(init());
</script>

</body>
</html>